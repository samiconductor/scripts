#!/usr/bin/env python3

# pip3 install exifread python-magic

import argparse
import logging
import sys
import re
import hashlib
import exifread
import magic

from pathlib import Path
from datetime import datetime, timedelta

parser = argparse.ArgumentParser(description='Move and rename photos')
parser.add_argument('source', help='Source folder to read media from')
parser.add_argument('--photos', required=True, help='Destination folder to move photos to')
parser.add_argument('--videos', required=True, help='Destination folder to move videos to')
parser.add_argument('--remove', type=int, help='Remove files older than provided days')
parser.add_argument('--recent', type=int, help='Skip files recently modified within the provided minutes')
parser.add_argument('--verbose', action='store_true', help='Print verbose output')

copied_count = 0
already_copied_count = 0
skip_recent_count = 0
removed_count = 0
shasum_mismatch_count = 0

def ensure_path_exists(path):
    if not path.exists():
        print('The path {} does not exist!'.format(path), file=sys.stderr)
        exit(1)

def get_date(path, is_image=False):
    # image EXIF date
    if is_image:
        with path.open('rb') as image:
            tags = exifread.process_file(image)

            if 'EXIF DateTimeOriginal' in tags:
                image_date = tags['EXIF DateTimeOriginal']
                split_date = [int(x) for x in re.sub(r'[^0-9]', ' ', str(image_date)).split(' ')]

                logging.info('Using image {} EXIF date {}'.format(path, image_date))

                return datetime(*split_date)

    # file name with YYYYMMDD HHMMSS or YYYY-MM-DD HH:MM:SS date
    file_name_date_match = re.search(r'(\d{4}).?(\d{2}).?(\d{2}).?(\d{2}).?(\d{2}).?(\d{2})', path.stem)

    if file_name_date_match:
        split_date = [int(x) for x in file_name_date_match.groups()]

        try:
            file_name_date = datetime(*split_date)

            logging.info('Using date format of file {} with date {}'.format(path, file_name_date))

            return file_name_date
        except ValueError:
            logging.info('Matched date format of file {} is not a valid date'.format(path))

    # modify time
    modify_date = get_modify_date(path)

    logging.info('Using file {} modify date {}'.format(path, modify_date))

    return modify_date

def get_modify_date(path):
    return datetime.fromtimestamp(path.stat().st_mtime)

def shasum_path(path):
    sha = hashlib.sha256()
    sha.update(path.read_bytes())

    return sha.digest()

def find_unique_path(path, shasum, count=1):
    incremented_path = path.with_name('{}_{}{}'.format(path.stem, count, path.suffix))

    if incremented_path.exists():
        if shasum == shasum_path(incremented_path):
            return (incremented_path, False)

        return find_unique_path(path, shasum, count + 1)

    return (incremented_path, True)

def remove_old_path(path):
    if keep_old_path_days is None:
        return

    time_since_path_modified = datetime.now() - datetime.fromtimestamp(path.stat().st_mtime)

    if time_since_path_modified.days > keep_old_path_days:
        logging.info('Remove path {} that is older than {} days: last modified {} days ago'.format(path, keep_old_path_days, time_since_path_modified.days))
        path.unlink()
        return True

args = parser.parse_args()

source_path = Path(args.source)
dest_photos_path = Path(args.photos)
dest_videos_path = Path(args.videos)
keep_old_path_days = args.remove
skip_recent_modified_minutes = args.recent
verbose = args.verbose

logging_level = logging.INFO if args.verbose else logging.ERROR
logging.basicConfig(format='%(asctime)s %(levelname)s %(message)s', level=logging_level, stream=sys.stdout)

ensure_path_exists(source_path)
ensure_path_exists(dest_photos_path)
ensure_path_exists(dest_videos_path)

logging.info('--- Move Media ---')
logging.info('Source: {}'.format(source_path))
logging.info('Photos Destination: {}'.format(dest_photos_path))
logging.info('Videos Destination: {}'.format(dest_videos_path))
if skip_recent_modified_minutes is not None:
    logging.info('Skipping files modified less than {} minutes ago'.format(skip_recent_modified_minutes))
if keep_old_path_days is not None:
    logging.info('Removing copied files older than {} days'.format(keep_old_path_days))

for path in source_path.glob('**/*'):
    if not path.is_file():
        continue

    mime = magic.from_file(str(path), mime=True)
    image_mime = mime.startswith('image')
    video_mime = mime.startswith('video')
    media_mime = image_mime or video_mime

    if not media_mime:
        logging.warning('Skipping non-media file {}'.format(path))
        continue

    if skip_recent_modified_minutes is not None:
        modify_date = get_modify_date(path)
        if datetime.now() - modify_date < timedelta(minutes = skip_recent_modified_minutes):
            logging.info('Skipping file modified less than {} minutes ago {}'.format(skip_recent_modified_minutes, path))
            skip_recent_count += 1
            continue

    file_date = get_date(path, is_image=image_mime)
    dest_path = dest_photos_path if image_mime else dest_videos_path
    date_path = dest_path / str(file_date.year)
    file_date_path = date_path / '{}{}'.format(file_date.strftime('%Y-%m-%d %H-%M-%S'), path.suffix)

    if file_date_path.exists():
        source_shasum = shasum_path(path)

        if source_shasum == shasum_path(file_date_path):
            logging.info('Media file {} already copied to {}'.format(path, file_date_path))
            already_copied_count += 1
            if remove_old_path(path):
                removed_count += 1
            continue

        file_date_path, unique_found = find_unique_path(file_date_path, source_shasum)

        if not unique_found:
            logging.info('Media file {} already copied to {}'.format(path, file_date_path))
            already_copied_count += 1
            if remove_old_path(path):
                removed_count += 1
            continue

    date_path.mkdir(parents=True, exist_ok=True)
    file_date_path.write_bytes(path.read_bytes())
    copied_count += 1

    logging.info('Media file {} copied to {}'.format(path, file_date_path))

    if shasum_path(path) == shasum_path(file_date_path):
        if remove_old_path(path):
            removed_count += 1
    else:
        logging.warning('Shasum of copied file {} and destination file {} do not match!'.format(path, file_date_path))
        shasum_mismatch_count += 1

logging.info('---Move Media Complete---')
logging.info('Copied {} files'.format(copied_count))
logging.info('Skipped {} files that were already copied'.format(already_copied_count))
if shasum_mismatch_count > 0:
    logging.info('There were {} copied shasum mismatches'.format(shasum_mismatch_count))
if skip_recent_modified_minutes is not None:
    logging.info('Skipped {} files that were modified less than {} minutes ago'.format(skip_recent_count, skip_recent_modified_minutes))
if keep_old_path_days is not None:
    logging.info('Removed {} files older than {} days'.format(removed_count, keep_old_path_days))
